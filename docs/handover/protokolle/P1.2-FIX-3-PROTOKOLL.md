# P1.2-FIX-3 PROTOKOLL - Token Daten laden (Indexer Debug)

```
+==============================================================+
|  PROTOKOLL: P1.2-FIX-3 - Token Data Loading                  |
|  Datum: 2025-12-03                                           |
|  Status: TEILWEISE GELOEST                                   |
+==============================================================+
```

## PROBLEM

Token-Liste zeigt keine Daten an:
- `/api/krc20/tokens` gibt leeres Array zurueck
- `krc20_tokens` Tabelle hat 0 Eintraege
- Indexer laeuft, synchronisiert aber keine Tokens

## ROOT CAUSE ANALYSE

### 1. WebSocket-Verbindung fehlte
- `kaspa-rpc.service.ts` versuchte HTTP auf Port 17110
- Rusty-Kaspa nutzt nur WebSocket, kein HTTP REST
- Fehler: "Failed to get blue score: TypeError: fetch failed"

### 2. Falsches Response-Format
- Rusty-Kaspa wRPC gibt Daten in `params` zurueck, nicht `result`
- Format: `{"id":1,"method":"getBlockDagInfo","params":{...}}`
- Standard JSON-RPC erwartet: `{"id":1,"result":{...}}`

### 3. Kaspa Node Ports
```
Port 16110: gRPC (binary)
Port 17110: wRPC Borsh (binary WebSocket)
Port 18110: wRPC JSON (JSON WebSocket) <-- Korrekt fuer uns
```

## LOESUNGEN

### 1. WebSocket Package installiert
```bash
npm install ws @types/ws
```

### 2. kaspa-rpc.service.ts komplett ueberarbeitet
- Import von `ws` Package hinzugefuegt
- Echte WebSocket-Verbindung zu `ws://127.0.0.1:18110`
- Reconnection-Logik mit max 10 Versuchen
- Pending-Request-Management mit Timeouts

### 3. Response-Parsing korrigiert
```typescript
// Rusty-Kaspa wRPC returns data in 'params' field, not 'result'
const result = message.result ?? message.params;
pending.resolve(result);
```

## ERGEBNIS

### Was funktioniert:
- WebSocket-Verbindung zu Kaspa Node: OK
- BlueScore abrufen: OK (aktuell ~293 Mio)
- Indexer Status-Tracking: OK
- Resync-Endpoint: OK

### Was noch nicht funktioniert:
- Block-Abruf: `getBlocks` RPC gibt keine echten Blockdaten
- KRC-20 Parsing: Keine Blocks = keine Tokens
- Token-Indexierung: 0 Tokens in DB

### Indexer Status nach Fix:
```json
{
  "indexer": {
    "name": "krc20-main",
    "isRunning": true,
    "lastBlueScore": "292970300",
    "totalTokensIndexed": 0
  },
  "rpc": {
    "connected": true,
    "url": "ws://127.0.0.1:18110"
  }
}
```

## OFFENE PUNKTE (fuer spaeter)

1. **Block-Subscription implementieren**
   - `notifyBlockAddedRequest` RPC verwenden
   - Neue Bloecke in Echtzeit empfangen

2. **Historische Daten laden**
   - Snapshot von bestehendem Indexer importieren
   - Oder Kasplex API fuer initialen Datenimport nutzen

3. **KRC-20 OP_RETURN Parsing**
   - Transaction-Scripts analysieren
   - Deploy/Mint/Transfer Operationen erkennen

## DATEIEN GEAENDERT

### API (kaspa-nexus-api)
```
package.json             - ws + @types/ws hinzugefuegt
src/modules/krc20-indexer/kaspa-rpc.service.ts - Komplette Ueberarbeitung
```

## TECHNISCHE DETAILS

### Kaspa wRPC Test (funktioniert):
```javascript
const WebSocket = require('ws');
const ws = new WebSocket('ws://127.0.0.1:18110');
ws.send(JSON.stringify({id:1, method:'getBlockDagInfo', params:{}}));
// Response: {"id":1,"method":"getBlockDagInfo","params":{"virtualDaaScore":292971964,...}}
```

### Korrekter Default-Port:
```typescript
this.rpcUrl = this.configService.get<string>(
  'KASPA_WRPC_URL',
  'ws://127.0.0.1:18110',  // JSON wRPC, nicht 17110 (Borsh)
);
```

## NAECHSTE SCHRITTE

1. Block-Subscription implementieren (notifyBlockAddedRequest)
2. Oder: Initialdaten von Kasplex API importieren
3. Oder: Snapshot von bestehendem Indexer laden

---

*Protokoll erstellt: 2025-12-03*
*Status: WebSocket-Verbindung repariert, Block-Indexierung noch ausstehend*
