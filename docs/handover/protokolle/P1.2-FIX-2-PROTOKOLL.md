# P1.2-FIX-2 PROTOKOLL - API Verbindung reparieren

```
+==============================================================+
|  PROTOKOLL: P1.2-FIX-2 - API Connection Fix                  |
|  Datum: 2025-12-02                                           |
|  Status: ABGESCHLOSSEN                                       |
+==============================================================+
```

## PROBLEME

### Problem 1: 401 Unauthorized
- Platform brauchte API-Key fuer api.kaspa-nexus.io
- KRC-20 Endpoints erfordern Authentifizierung

### Problem 2: 404 Not Found
- `/v1/market/gainers` existierte nicht
- `/v1/market/losers` existierte nicht
- Korrekte Endpoints: `/v1/krc20/gainers` und `/v1/krc20/losers`

## LOESUNGEN

### 1. Interner API-Key erstellt
- Format: `knx_` prefix + 32 hex chars
- In DB: SHA256 gehasht gespeichert
- Tier: ENTERPRISE (unlimited rate-limit)
- Status: ACTIVE

```sql
INSERT INTO api_keys (
  id, key, name, tier, status, "rateLimit", "dailyLimit"
) VALUES (
  'platform-internal-001',
  '<sha256_hash>',
  'PLATFORM-INTERNAL',
  'ENTERPRISE',
  'ACTIVE',
  999999,
  999999999
);
```

### 2. .env.local erstellt
```
NEXT_PUBLIC_API_URL=https://api.kaspa-nexus.io
INTERNAL_API_KEY=knx_baded36600d8bdf8906ba5f7a9b2bc98
```

### 3. Server-Side API Routes erstellt
Da API-Key nicht im Browser sein soll, wurden Next.js API Routes erstellt:

- `/api/krc20/tokens` - Proxy fuer Token-Liste
- `/api/krc20/gainers` - Proxy fuer Top Gainers
- `/api/krc20/losers` - Proxy fuer Top Losers

Diese Routes senden den API-Key serverseitig.

### 4. Komponenten aktualisiert
Alle Komponenten nutzen jetzt die lokalen API Routes:

- `GainersLosers.tsx`: `/api/krc20/gainers` + `/api/krc20/losers`
- `TopTokensList.tsx`: `/api/krc20/tokens`
- `krc20/tokens/page.tsx`: `/api/krc20/tokens`

### 5. Config korrigiert
`src/config/api.ts`:
- `INTERNAL_API_KEY` env variable
- Endpoints korrigiert: `/krc20/gainers`, `/krc20/losers`

## NEUE DATEIEN

```
.env.local
src/app/api/krc20/tokens/route.ts
src/app/api/krc20/gainers/route.ts
src/app/api/krc20/losers/route.ts
```

## GEAENDERTE DATEIEN

```
src/config/api.ts
src/components/market/GainersLosers.tsx
src/components/market/TopTokensList.tsx
src/app/krc20/tokens/page.tsx
```

## DATENBANK

API-Key in `api_keys` Tabelle:
- ID: `platform-internal-001`
- Name: `PLATFORM-INTERNAL`
- Tier: `ENTERPRISE`
- Rate Limit: 999999 req/min
- Daily Limit: 999999999 req/day

## API ENDPOINTS

| Route | Externer Endpoint | Auth |
|-------|-------------------|------|
| `/api/krc20/tokens` | `/v1/krc20/tokens` | API-Key |
| `/api/krc20/gainers` | `/v1/krc20/gainers` | API-Key |
| `/api/krc20/losers` | `/v1/krc20/losers` | API-Key |
| `/v1/kaspa/price` | - | Offen |
| `/v1/market/overview` | - | Offen |

## BUILD STATUS

```
Build: OK
Routes:
+-- /api/krc20/gainers      0 B
+-- /api/krc20/losers       0 B
+-- /api/krc20/tokens       0 B
```

---

*Protokoll erstellt: 2025-12-02*
